# Build a GraphQL Serverless API for a Simple Schema using Panacloud CLI and Deploy it on AWS

## Prerequisites
Before getting started you need to install the following packages and libraries:

1. Install [Node.js](https://nodejs.org/en/)
2. Install [AWS CLI Version 2.x](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html)
3. Install [AWS CDK Version 2](https://docs.aws.amazon.com/cdk/latest/guide/work-with-cdk-v2.html)
4. Install Globally [TypeScript](https://www.typescriptlang.org/download)

## Getting Started
Once you've prepared your environment with the prerequisites, go ahead and globally install the Panacloud CLI:

     npm install @panacloud/cli -g 

To check the installed version and confirm the successful installation of the Panacloud CLI:

     panacloud version

Panacloud recommends using API-First and API Design-First approach in developing APIs.

Please read these articles to understand the approach:

[API-First, API Design-First, or Code-First: Which Should You](https://blog.stoplight.io/api-first-api-design-first-or-code-first-which-should-you-choose)

[Schema-First GraphQL: The Road Less Travelled](https://blog.mirumee.com/schema-first-graphql-the-road-less-travelled-cf0e50d5ccff)

In order to start learning to develop Serverless GraphQL APIs we have developed a very simple schema in the `user.graphql` file at the root of this tutorial.

You can learn how to develop GraphQL schemas from [the schema official documentation](https://graphql.org/learn/schema/)

Now we will generate an AWS CDK project using the panacloud cli.

     mkdir my_user_api

     cd my_user_api

     panacloud init

On the command promt answer the question:


GraphQL Schema File Path? ../user.graphql

API Name? MyUserAPI

Nested Resolver? No

Select Database? Neptune (Graph) 

Select Query Language? Gremlin

Now the MyUserAPI code is generated and available in the `my_user_api` directory.

Now lets review the different directories and files in the project generated by the CLI.

## Understand the Project Generated by the CLI

The CLI generated project in the `my_user_api` directory for a Serverless API given the GraphQL schema in the `user.graphql` file.  It is a [AWS Cloud Development Kit (CDK)](https://docs.aws.amazon.com/cdk/latest/guide/home.html) project using TypeScript. It comes with all the necessary code to develop and deploy a Serverless GraphQL API in the AWS Cloud.  This includes the provisioning of cloud infrastructure in code and Serverless stubs where developers may easily include their business logic. The project also provides pre-built mock lambda functions and unit tests to test your deployed APIs. 

The project code may be conceptually divided into two parts:

1. The code that is generated by the Panacloud CLI, and will continuously be updated by the CLI as your API schema evolves. If the developer edits and updated this code, it will be overwritten next time the schema is updated and Panacloud CLI update command is given.
2. The code that the developer edits and updates and contains the business logic for the APIs. This code is contained in the `editable_src/` directory. 

It is highly recommended that the developer only edit and update the code contained in the `editable_src/` directory because the rest of the code is generated and updated by the Panacloud CLI.

The generated project code includes the mock lambdas contained in the `mock_lambda` and `mock_lambda_layer` directory in the root project folder. Typically, the developer will write business logic in the stub lambdas contained in the `editable_src/lambdas_stubs/` directory. 

The configuration contained in the `editable_src/panacloudconfig.json` file decides which lambda the APIs will call. Therefore, the project may be using mock lambdas in some calls and the real stub lambdas in other calls. This flexibility allows the developer to seamlessly transition from mock APIs towards real APIs using the stubs, without the API users and testers even noticing it. Also, the mock APIs may be deployed right away.

The API CDK stack (cloud infrastructure in code) is generated by the Panacloud CLI `panacloud init` command given the API schema. API development is an iterative process, therefore when the developer updates the API schema in the `editable_src/graphql/schema/` directory and runs the `panacloud update` command the project's CDK code is updated. Given this cycle, most of the CDK stack is generated and updated by the Panacloud CLI. However, the developer has the flexibility to add and update the CDK stack by adding and updating visitors in the `editable_src/aspects/` directory. The Panacloud framework uses [Aspects](https://docs.aws.amazon.com/cdk/latest/guide/aspects.html) to enhance generated constructs and add cloud constructs written by the API developers.

The `editable_src/` directory contains all the code which the developer edits.  

The `editable_src/lambdas_stubs/` directory contains all the lambda stubs where the developer writes the business logic.  

The `editable_src/customMockLambdaLayer/mockData` directory contains the editable mock data which developer can update and change.  

The `editable_src/panacloudconfig.json` file tells the Panacloud framework which lambda functions to call.

The `editable_src/aspects` directory contains all the CDK code which the developer adds to the project CDK stack.  

The `cdk.json` file tells the CDK Toolkit how to execute your app.


## Deploying the Serverless API Mocks in the AWS Cloud

Note: The official documentation of CDK version 2 is available [here](https://docs.aws.amazon.com/cdk/api/v2/)

Before we proceed to deploy the project lets first understand what it contains. 

If you have already not done so, you need to [bootstrap](https://docs.aws.amazon.com/cdk/latest/guide/bootstrapping.html) the cdk by using this command:

     cdk bootstrap

Once we are done with bootstrapping we want to deploy the Mock Serverless APIs. 

The project is already generated for you, you just have to compile it:

     npm run build

You may now deploy the project for development stage:

     npm run deploy-dev

After deploying check out the `cdk-dev-outputs.json` file in the project root it contains the URL and Key of the deployed APIs.

You may now deploy the project for production stage:

     npm run deploy-prd

After deploying check out the `cdk-prd-outputs.json` file in the project root it contains the URL and Key of the deployed APIs.

After a deployment of dev stage is successuful you can run the automated tests on the deployed API:

     npm run test-dev

After a deployment of production stage is successuful you can run the automated tests on the deployed API:

     npm run test-prd


You can call the APIs by using this command which will open an client for your API:

     panacloud client

Note: Right now you are running mock APIs therefore it will only give you responses to mock queries with fixed data.
For example, the mock data for the user query is in the `mock_lambda_layer/mockData/user` file of your generated project. Therefore, only those queries will be successful which will use this mock data.


Now you may destroy the deployed development stage just give this command:

     npm run destroy-dev

Now you may destroy the deployed production stage just give this command:

     npm run destroy-dev


 










